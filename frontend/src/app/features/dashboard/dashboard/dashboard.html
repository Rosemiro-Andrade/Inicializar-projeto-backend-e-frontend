<h1>Dashboard Geral</h1>

<div class="dashboard-actions">
  <button mat-raised-button color="primary" (click)="atualizarDashboard()">
    Atualizar Dashboard
  </button>

  <!-- Filtro de data -->
  <label>
    Filtrar por data:
    <input type="date" [value]="dataSelecionada" (change)="dataSelecionada = $any($event.target).value">
  </label>
</div>

<mat-accordion multi>
  <mat-expansion-panel *ngFor="let stage of stages">
    <mat-expansion-panel-header>
      <mat-panel-title>{{ stage.nome }}</mat-panel-title>
      <mat-panel-description>
        <mat-progress-spinner
          *ngIf="getPercentualStage(stage) !== 0"
          [mode]="'determinate'"
          [value]="getPercentualStage(stage)"
          [diameter]="50"
          [strokeWidth]="6"
          [color]="getCor(getPercentualStage(stage))">
        </mat-progress-spinner>
        {{ getPercentualStage(stage) | number:'1.0-0' }}%
      </mat-panel-description>
    </mat-expansion-panel-header>

    <div *ngFor="let maquina of stage.maquinas" class="machine-card">
      <h3 (click)="verDetalhes(maquina)" style="cursor:pointer;">
        {{ maquina.nome }}
      </h3>

      <div *ngIf="getUltimoRegistro(maquina) as ultimo">
        <p>
          √öltimo registro: {{ ultimo.slot_identificacao }} ‚Äî {{ ultimo.porcentagem | number:'1.0-0' }}%
        </p>
        <mat-progress-bar
          mode="determinate"
          [value]="ultimo.porcentagem"
          [color]="getCor(ultimo.porcentagem)">
        </mat-progress-bar>
      </div>

      <table *ngIf="getUltimosRegistros(maquina).length > 0">
        <thead>
          <tr>
            <th>Slot</th>
            <th>Funcionando</th>
            <th>Total</th>
            <th>%</th>
            <th>M√≥dulo</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let registro of getUltimosRegistros(maquina)">
            <td>{{ registro.slot_identificacao }}</td>
            <td>{{ registro.funcionando }}</td>
            <td>{{ registro.quantidade_total }}</td>
            <td>
              <mat-progress-bar
                mode="determinate"
                [value]="registro.porcentagem"
                [color]="getCor(registro.porcentagem)">
              </mat-progress-bar>
              {{ registro.porcentagem | number:'1.0-0' }}%
            </td>
            <td>{{ registro.modulo }}</td>
            <td>{{ formatarData(registro.data_registro) }}</td>
            <td>
                <button mat-mini-fab color="primary" (click)="imprimirRegistro(registro, maquina)">
                  üñ®Ô∏è 
                </button>
            </td>
            <td>
                <button mat-raised-button color="accent" (click)="imprimirMaquina(maquina)">
                  üñ®Ô∏è Imprimir registros da {{ maquina.nome }}
                </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </mat-expansion-panel>
</mat-accordion>