<h1>Dashboard Geral</h1>

<button mat-raised-button color="primary" (click)="atualizarDashboard()">
  Atualizar Dashboard
</button>

<mat-accordion multi>
  <!-- Itera pelos stages -->
  <mat-expansion-panel *ngFor="let stage of stages">
    <mat-expansion-panel-header>
      <mat-panel-title>
        {{ stage.nome }}
      </mat-panel-title>

      <mat-panel-description>
        <!-- Rosca de porcentagem -->
        <mat-spinner
          *ngIf="getPercentualStage(stage) !== 0"
          [mode]="'determinate'"
          [value]="getPercentualStage(stage)"
          [diameter]="50"
          [strokeWidth]="6">
          [color]="getCor(getPercentualStage(stage))">
        </mat-spinner>

        {{ getPercentualStage(stage) | number:'1.0-0' }}%
      </mat-panel-description>
    </mat-expansion-panel-header>

    <!-- Itera pelas máquinas do stage -->
    <div *ngFor="let maquina of stage.maquinas" class="machine-card">
      <!-- Clique para detalhes da máquina -->
      <h3 (click)="verDetalhes(maquina)" style="cursor:pointer;">
        {{ maquina.nome }}
      </h3>

      <!-- Último registro da máquina -->
      <div *ngIf="getUltimoRegistro(maquina) as ultimo">
        <p>
          Último registro: {{ ultimo.slot_identificacao }} — 
          {{ ultimo.porcentagem | number:'1.0-0' }}%
        </p>
        <mat-progress-bar
          mode="determinate"
          [value]="ultimo.porcentagem"
          [color]="getCor(ultimo.porcentagem)">
        </mat-progress-bar>
      </div>

      <!-- Tabela de histórico de registros -->
      <table *ngIf="(maquina.registros ?? []).length > 0">
        <thead>
          <tr>
            <th>Slot</th>
            <th>Funcionando</th>
            <th>Total</th>
            <th>%</th>
            <th>Módulo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let registro of maquina.registros">
            <td>{{ registro.slot_identificacao }}</td>
            <td>{{ registro.funcionando }}</td>
            <td>{{ registro.quantidade_total }}</td>
            <td>
              <mat-progress-bar
                mode="determinate"
                [value]="registro.porcentagem"
                [color]="getCor(registro.porcentagem)">
              </mat-progress-bar>
              {{ registro.porcentagem | number:'1.0-0' }}%
            </td>
            <td>{{ registro.modulo }}</td>
          </tr>
        </tbody>
      </table>

    </div>
  </mat-expansion-panel>
</mat-accordion>